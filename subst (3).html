<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師代課系統</title>
    <style>
        /* 保持原有樣式不變 */
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        /* 其他樣式保持不變... */
    </style>
</head>
<body>
    <!-- 保持原有HTML結構不變... -->
    <script>
        // 全局變量存儲課程數據
        let timetableData = [];
        let allTeachers = [];
        let substData = {};
        
        // 頁面加載時讀取CSV數據
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面加載完成，開始讀取數據');
            document.getElementById('result').innerHTML = '<div class="loading">正在加載數據...</div>';
            
            // 使用Promise.all同時讀取兩個CSV文件
            Promise.all([
                fetchCSV('tt.csv'),
                fetchCSV('subst.csv')
            ])
            .then(([ttData, substDataText]) => {
                // 解析代堂數據
                substData = parseSubstCSV(substDataText);
                console.log('代堂數據:', substData);
                
                // 解析課程表數據
                timetableData = parseTimetableCSV(ttData);
                console.log('課程數據:', timetableData);
                
                if (timetableData.length === 0) {
                    throw new Error('課程數據文件沒有有效數據');
                }
                
                // 初始化教師列表和UI
                initTeachers();
            })
            .catch(error => {
                console.error('讀取數據時出錯:', error);
                showError(`錯誤: ${error.message}<br>
                可能原因:<br>
                1. CSV文件不存在<br>
                2. CSV格式不正確<br>
                3. 服務器未正確配置CORS<br>
                請檢查瀏覽器控制台獲取詳細信息`);
            });
            
            // 綁定生成按鈕事件
            document.getElementById('generateBtn').addEventListener('click', generateSubstitutes);
        });

        // 新增：專門用於獲取CSV文件的函數
        function fetchCSV(filename) {
            return fetch(filename)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`無法讀取 ${filename}: ${response.status}`);
                    }
                    // 檢查內容類型，處理可能的BOM字符
                    return response.text().then(text => {
                        // 移除可能的BOM字符
                        return text.replace(/^\uFEFF/, '');
                    });
                });
        }

        // 新增：專門解析代堂CSV的函數
        function parseSubstCSV(csvData) {
            const data = {};
            const lines = csvData.split(/\r?\n/);
            
            lines.forEach(line => {
                if (line.trim()) {
                    const [teacher, value] = line.split(',');
                    if (teacher && teacher !== 'Initial' && !isNaN(parseInt(value))) {
                        data[teacher.trim()] = parseInt(value.trim());
                    }
                }
            });
            return data;
        }

        // 新增：專門解析課程表CSV的函數
        function parseTimetableCSV(csvData) {
            const result = [];
            const lines = csvData.split(/\r?\n/);
            
            // 跳過可能的標題行
            let startLine = /^\D/.test(lines[0]) ? 1 : 0;
            
            for (let i = startLine; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // 處理可能包含逗號的字段
                const fields = line.match(/(?:[^,"]+|"[^"]*")+/g) || [];
                const cleanedFields = fields.map(field => 
                    field.replace(/^"(.*)"$/, '$1').trim()
                );
                
                if (cleanedFields.length >= 7) {
                    result.push({
                        year: cleanedFields[0],
                        day: parseInt(cleanedFields[1]) || 0,
                        period: parseInt(cleanedFields[2]) || 0,
                        teacher: cleanedFields[3],
                        class: cleanedFields[4],
                        subject: cleanedFields[5],
                        room: cleanedFields[6]
                    });
                }
            }
            return result;
        }

        // 初始化教師列表
        function initTeachers() {
            // 提取所有教師名單
            allTeachers = [...new Set(timetableData.map(item => item.teacher))].sort();
            
            // 填充教師下拉選單
            const teacherSelect = document.getElementById('teacherSelect');
            teacherSelect.innerHTML = '<option value="">-- 選擇教師 --</option>';
            allTeachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher + (substData[teacher] !== undefined ? ` (${substData[teacher]})` : '');
                teacherSelect.appendChild(option);
            });
            
            // 填充排除教師複選框
            const excludeTeachersDiv = document.getElementById('excludeTeachers');
            excludeTeachersDiv.innerHTML = '';
            allTeachers.forEach(teacher => {
                const div = document.createElement('div');
                div.className = 'teacher-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `exclude-${teacher}`;
                checkbox.value = teacher;
                
                const label = document.createElement('label');
                label.htmlFor = `exclude-${teacher}`;
                label.textContent = teacher;
                
                if (substData[teacher] !== undefined) {
                    const substSpan = document.createElement('span');
                    substSpan.className = 'subst-value';
                    substSpan.textContent = `(${substData[teacher]})`;
                    label.appendChild(substSpan);
                }
                
                div.appendChild(checkbox);
                div.appendChild(label);
                excludeTeachersDiv.appendChild(div);
            });
            
            // 設置輸入框和下拉選單的聯動
            const teacherInput = document.getElementById('teacherInput');
            document.getElementById('teacherSelect').addEventListener('change', function() {
                teacherInput.value = this.value;
            });
            
            teacherInput.addEventListener('input', function() {
                const inputValue = this.value.toUpperCase();
                const options = document.getElementById('teacherSelect').options;
                
                for (let i = 0; i < options.length; i++) {
                    if (options[i].text.toUpperCase().includes(inputValue)) {
                        options[i].selected = true;
                        break;
                    }
                }
            });
            
            document.getElementById('result').innerHTML = '<div class="loading">數據加載完成，請輸入查詢條件</div>';
        }

        // 顯示錯誤信息
        function showError(message) {
            document.getElementById('result').innerHTML = 
                `<div class="error">${message}</div>`;
        }

        /* 保持原有的 generateSubstitutes() 和 displayResults() 函數不變 */
        // ... [其他函數保持不變]
    </script>
</body>
</html>
