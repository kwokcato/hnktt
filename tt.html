<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSP 與 nonce -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'nonce-r4nd0m123' https://cdnjs.cloudflare.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data:;
      frame-ancestors 'self';
      connect-src 'self';
      base-uri 'self';
      form-action 'self';
      object-src 'none';
      upgrade-insecure-requests
    ">

    <link rel="stylesheet" type="text/css" href="hnkstyle.css">
    <title>教師/班別時間表查詢</title>

    <script nonce="r4nd0m123">
    // 參數設定
    const CLIENT_ID = "920942611875-eikfedkn3rno9am41fi08sbqniml566c.apps.googleusercontent.com";
    const SCHOOL_DOMAIN = "bhnkc.edu.hk";

    function decodeJwtResponse(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
                '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
            ).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) { return null; }
    }
    function isTokenValid(token) {
        const p = decodeJwtResponse(token);
        if (!p) return false;
        const issOk = p.iss === "https://accounts.google.com" || p.iss === "accounts.google.com";
        const audOk = p.aud === CLIENT_ID;
        const hdOk = p.hd === SCHOOL_DOMAIN;
        const notExpired = p.exp && (p.exp * 1000) > Date.now();
        return issOk && audOk && hdOk && notExpired;
    }

    // 檢查 sessionStorage 中是否有有效的登入憑證，否則導回登入
    (function guard() {
        const id_token = window.sessionStorage.getItem('google_id_token');
        if (!id_token || !isTokenValid(id_token)) {
            window.top.location.href = 'index.html';
        }
    })();
    </script>

    <style>
        #result h3 { margin: 5px 0; padding: 0; }
        #timetable { margin-top: 0; }
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px; margin: 0 auto; padding: 0;
        }
        h1 { color: #2c3e50; text-align: center; }
        .container { display: flex; flex-direction: column; gap: 0; }
        .input-section {
            display: flex; gap: 10px; align-items: center; background-color: #f5f5f5;
            padding: 7px; border-radius: 5px; flex-wrap: wrap;
        }
        .dropdown-group { display: flex; gap: 10px; align-items: center; flex-grow: 1; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th, td {
            border: 1px solid #ddd; padding: 8px; text-align: center;
            width: 18ch; max-width: 18ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        th { background-color: #3498db; color: white; }
        .period-col {
            width: 5ch !important; max-width: 5ch; background-color: #3498db; color: white; font-weight: bold;
        }
        .time-col {
            width: 10ch !important; max-width: 10ch; background-color: #3498db; color: white; font-weight: bold;
        }
        tr:nth-child(even) { background-color: #ffffff; }
        .empty-cell { background-color: #ffffff; }
        .break-cell { background-color: #e6e6e6; color: #777; font-style: italic; }
        .main-lesson { font-weight: bold; white-space: normal; word-wrap: break-word; display: inline-block; max-width: 100%; text-align: center; }
        .co-teachers, .dismissal-time { font-size: 0.9em; color: #666; }
        .dismissal-time { font-style: italic; }
        select, input {
            padding: 8px; border-radius: 4px; border: 1px solid #ddd;
        }
        input { width: 120px; }
        .hidden { display: none; }
        .export-btn {
            padding: 10px 15px; margin: 0 5px; background-color: #3498db; color: white;
            border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        .export-btn:hover { background-color: #2980b9; }
        .dropdown-group #exportBtnGroup { margin-left: auto; display: flex; justify-content: flex-end; }
        .container > #exportBtnGroup { text-align: center; margin-top: 20px; }
        .refresh-btn {
            position: fixed; bottom: 16px; right: 16px; width: 44px; height: 44px; border-radius: 999px;
            background: rgba(0,0,0,0.1); display: grid; place-items: center; cursor: pointer;
            transition: transform .3s ease, background-color .3s ease;
        }
        .refresh-btn:hover { background: rgba(0,0,0,0.2); }
        .refresh-icon {
            width: 20px; height: 20px; border: 2px solid #555; border-top-color: transparent; border-radius: 50%;
        }
        @media (prefers-reduced-motion: reduce) {
            .refresh-btn { transition: none; }
        }
        @media (prefers-color-scheme: dark) {
            body { background: #111; color: #eee; }
            .input-section { background-color: #1c1c1c; }
            th, .period-col, .time-col { background-color: #1e6da3; }
            .refresh-btn { background: rgba(255,255,255,0.1); }
            .refresh-icon { border-color: #ddd; border-top-color: transparent; }
        }
    </style>
</head>
<body>
    <div class="refresh-btn" title="重整頁面" aria-label="重整頁面">
        <div class="refresh-icon"></div>
    </div>

    <div class="container">
        <strong>教師/班別時間表查詢</strong>
        <div class="input-section">
            <label for="teacherName" class="sr-only" aria-hidden="true" style="position:absolute;left:-9999px;">教師或班別搜尋</label>
            <input type="text" id="teacherName" placeholder="輸入教師姓名或班別 (如 1A)" aria-label="教師姓名或班別">
            <div class="dropdown-group">
                <span>或</span>
                <label for="teacherDropdown" class="sr-only" aria-hidden="true" style="position:absolute;left:-9999px;">選擇教師</label>
                <select id="teacherDropdown" aria-label="選擇教師">
                    <option value="">選擇教師...</option>
                </select>
                <span>或</span>
                <label for="classDropdown" class="sr-only" aria-hidden="true" style="position:absolute;left:-9999px;">選擇班別</label>
                <select id="classDropdown" aria-label="選擇班別">
                    <option value="">選擇班別...</option>
                </select>
                <div id="exportBtnGroup" aria-label="匯出選項"></div>
            </div>
        </div>

        <div id="loading" role="status" aria-live="polite">載入時間表數據中...</div>
        <div id="result"></div>
        <table id="timetable" aria-describedby="loading">
            <!-- 時間表將在這裡動態生成 -->
        </table>
    </div>

    <script nonce="r4nd0m123">
        // 可切換：封鎖右鍵/DevTools（預設關閉）
        const ENABLE_DEVTOOLS_BLOCK = false;
        if (ENABLE_DEVTOOLS_BLOCK) {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'F12' ||
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
                    (e.ctrlKey && e.key.toLowerCase() === 'u')) {
                    e.preventDefault();
                }
            });
        }

        // Refresh 動畫與重載
        document.querySelector('.refresh-btn').addEventListener('click', function() {
            this.style.transform = 'scale(1.2) rotate(360deg)';
            this.style.backgroundColor = 'rgba(150, 150, 150, 0.8)';
            setTimeout(() => { location.reload(); }, 600);
        });

        // 若 token 在使用期間失效，主頁會處理登出；本頁也在獲得焦點時做基本檢查
        window.addEventListener('focus', () => {
            const t = sessionStorage.getItem('google_id_token');
            if (!t || !isTokenValid(t)) window.top.location.href = 'index.html';
        });
    </script>

    <!-- 如 timetable.js 需要 XLSX，保留 CDN 載入（可依需求改成按需載入） -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

    <script nonce="r4nd0m123">
        // 使用固定版本參數取代 document.write 與時間戳，利於快取與版本管理
        (function loadTimetable() {
            const ASSET_VERSION = '1.1.0';
            const s = document.createElement('script');
            s.src = 'timetable.js?v=' + encodeURIComponent(ASSET_VERSION);
            s.defer = true;
            document.head.appendChild(s);
        })();
    </script>
</body>
</html>
