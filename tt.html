<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Enhanced CSP with proper nonce handling -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'nonce-r4nd0m123' https://cdnjs.cloudflare.com;
      style-src 'self' 'nonce-style123';
      img-src 'self' data:;
      frame-ancestors 'self';
      connect-src 'self';
      base-uri 'self';
      form-action 'self';
      object-src 'none';
      upgrade-insecure-requests
    ">

    <link rel="stylesheet" type="text/css" href="hnkstyle.css" nonce="style123">
    <title>教師/班別時間表查詢</title>

    <script nonce="r4nd0m123">
    // Configuration with enhanced security
    const CONFIG = {
        CLIENT_ID: "920942611875-eikfedkn3rno9am41fi08sbqniml566c.apps.googleusercontent.com",
        SCHOOL_DOMAIN: "bhnkc.edu.hk",
        GOOGLE_CERTS_URL: "https://www.googleapis.com/oauth2/v3/certs"
    };

    // Cache for Google's public keys
    let publicKeys = null;

    // Fetch Google's public keys for JWT verification
    async function fetchPublicKeys() {
        try {
            const response = await fetch(CONFIG.GOOGLE_CERTS_URL);
            const data = await response.json();
            publicKeys = data;
            return data;
        } catch (error) {
            console.error('Failed to fetch public keys:', error);
            return null;
        }
    }

    // Decode JWT token
    function decodeJwtResponse(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
                '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
            ).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error('JWT decoding error:', e);
            return null;
        }
    }

    // Verify JWT signature
    async function verifyTokenSignature(token) {
        if (!publicKeys) {
            await fetchPublicKeys();
        }
        
        try {
            const header = JSON.parse(atob(token.split('.')[0]));
            const key = publicKeys[header.kid];
            
            if (!key) {
                console.error('No matching key found for kid:', header.kid);
                return false;
            }
            
            const algo = { name: 'RSASSA-PKCS1-v1_5', hash: { name: 'SHA-256' } };
            const keyData = {
                kty: key.kty,
                e: key.e,
                n: key.n,
                alg: key.alg,
                ext: true
            };
            
            const cryptoKey = await crypto.subtle.importKey(
                'jwk',
                keyData,
                algo,
                false,
                ['verify']
            );
            
            const signature = Uint8Array.from(atob(token.split('.')[2].replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0));
            const data = new TextEncoder().encode(`${token.split('.')[0]}.${token.split('.')[1]}`);
            
            return await crypto.subtle.verify(
                algo,
                cryptoKey,
                signature,
                data
            );
        } catch (error) {
            console.error('Signature verification failed:', error);
            return false;
        }
    }

    // Comprehensive token validation
    async function isTokenValid(token) {
        if (!token) return false;
        
        const p = decodeJwtResponse(token);
        if (!p) return false;
        
        // Basic claims validation
        const issOk = p.iss === "https://accounts.google.com" || p.iss === "accounts.google.com";
        const audOk = p.aud === CONFIG.CLIENT_ID;
        const hdOk = p.hd === CONFIG.SCHOOL_DOMAIN;
        const notExpired = p.exp && (p.exp * 1000) > Date.now();
        
        if (!issOk || !audOk || !hdOk || !notExpired) {
            return false;
        }
        
        // Verify signature
        return await verifyTokenSignature(token);
    }

    // Authentication guard
    async function guard() {
        const id_token = window.sessionStorage.getItem('google_id_token');
        if (!id_token || !(await isTokenValid(id_token))) {
            window.top.location.href = 'index.html';
        }
    }

    // Initialize guard
    guard();
    </script>

    <style nonce="style123">
        #result h3 { margin: 5px 0; padding: 0; }
        #timetable { margin-top: 0; }
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px; margin: 0 auto; padding: 0;
        }
        h1 { color: #2c3e50; text-align: center; }
        .container { display: flex; flex-direction: column; gap: 0; }
        .input-section {
            display: flex; gap: 10px; align-items: center; background-color: #f5f5f5;
            padding: 7px; border-radius: 5px; flex-wrap: wrap;
        }
        .dropdown-group { display: flex; gap: 10px; align-items: center; flex-grow: 1; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th, td {
            border: 1px solid #ddd; padding: 8px; text-align: center;
            width: 18ch; max-width: 18ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        th { background-color: #3498db; color: white; }
        .period-col {
            width: 5ch !important; max-width: 5ch; background-color: #3498db; color: white; font-weight: bold;
        }
        .time-col {
            width: 10ch !important; max-width: 10ch; background-color: #3498db; color: white; font-weight: bold;
        }
        tr:nth-child(even) { background-color: #ffffff; }
        .empty-cell { background-color: #ffffff; }
        .break-cell { background-color: #e6e6e6; color: #777; font-style: italic; }
        .main-lesson { font-weight: bold; white-space: normal; word-wrap: break-word; display: inline-block; max-width: 100%; text-align: center; }
        .co-teachers, .dismissal-time { font-size: 0.9em; color: #666; }
        .dismissal-time { font-style: italic; }
        select, input {
            padding: 8px; border-radius: 4px; border: 1px solid #ddd;
        }
        input { width: 120px; }
        .hidden { display: none; }
        .export-btn {
            padding: 10px 15px; margin: 0 5px; background-color: #3498db; color: white;
            border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        .export-btn:hover { background-color: #2980b9; }
        .dropdown-group #exportBtnGroup { margin-left: auto; display: flex; justify-content: flex-end; }
        .container > #exportBtnGroup { text-align: center; margin-top: 20px; }
        .refresh-btn {
            position: fixed; bottom: 16px; right: 16px; width: 44px; height: 44px; border-radius: 999px;
            background: rgba(0,0,0,0.1); display: grid; place-items: center; cursor: pointer;
            transition: transform .3s ease, background-color .3s ease;
        }
        .refresh-btn:hover { background: rgba(0,0,0,0.2); }
        .refresh-icon {
            width: 20px; height: 20px; border: 2px solid #555; border-top-color: transparent; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (prefers-reduced-motion: reduce) {
            .refresh-btn, .refresh-icon { transition: none; animation: none; }
        }
        @media (prefers-color-scheme: dark) {
            body { background: #111; color: #eee; }
            .input-section { background-color: #1c1c1c; }
            th, .period-col, .time-col { background-color: #1e6da3; }
            .refresh-btn { background: rgba(255,255,255,0.1); }
            .refresh-icon { border-color: #ddd; border-top-color: transparent; }
        }
    </style>
</head>
<body>
    <div class="refresh-btn" title="重整頁面" aria-label="重整頁面" role="button" tabindex="0">
        <div class="refresh-icon" aria-hidden="true"></div>
    </div>

    <div class="container">
        <h1>教師/班別時間表查詢</h1>
        <div class="input-section">
            <label for="teacherName" class="sr-only">教師或班別搜尋</label>
            <input type="text" id="teacherName" placeholder="輸入教師姓名或班別 (如 1A)" aria-label="教師姓名或班別">
            <div class="dropdown-group">
                <span>或</span>
                <label for="teacherDropdown" class="sr-only">選擇教師</label>
                <select id="teacherDropdown" aria-label="選擇教師">
                    <option value="">選擇教師...</option>
                </select>
                <span>或</span>
                <label for="classDropdown" class="sr-only">選擇班別</label>
                <select id="classDropdown" aria-label="選擇班別">
                    <option value="">選擇班別...</option>
                </select>
                <div id="exportBtnGroup" aria-label="匯出選項"></div>
            </div>
        </div>

        <div id="loading" role="status" aria-live="polite" aria-busy="true">載入時間表數據中...</div>
        <div id="result" aria-live="polite"></div>
        <table id="timetable" aria-describedby="loading">
            <!-- 時間表將在這裡動態生成 -->
        </table>
    </div>

    <script nonce="r4nd0m123">
        // Enhanced refresh button functionality
        document.querySelector('.refresh-btn').addEventListener('click', function() {
            this.style.transform = 'scale(1.2)';
            this.querySelector('.refresh-icon').style.animation = 'spin 0.6s linear 1';
            setTimeout(() => {
                location.reload();
            }, 600);
        });

        // Keyboard accessibility for refresh button
        document.querySelector('.refresh-btn').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });

        // Token validation on focus
        window.addEventListener('focus', async () => {
            const t = sessionStorage.getItem('google_id_token');
            if (!t || !(await isTokenValid(t))) {
                window.top.location.href = 'index.html';
            }
        });

        // Lazy load XLSX library only when needed
        let xlsxLoaded = false;
        async function loadXLSX() {
            if (!xlsxLoaded) {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                xlsxLoaded = true;
            }
            return window.XLSX;
        }

        // Export functionality
        async function setupExportButtons() {
            const exportBtnGroup = document.getElementById('exportBtnGroup');
            
            const excelBtn = document.createElement('button');
            excelBtn.className = 'export-btn';
            excelBtn.textContent = '匯出 Excel';
            excelBtn.addEventListener('click', async () => {
                const XLSX = await loadXLSX();
                // Implement Excel export logic here
                console.log('Export to Excel');
            });
            
            const pdfBtn = document.createElement('button');
            pdfBtn.className = 'export-btn';
            pdfBtn.textContent = '匯出 PDF';
            pdfBtn.addEventListener('click', () => {
                // Implement PDF export logic here
                console.log('Export to PDF');
            });
            
            exportBtnGroup.append(excelBtn, pdfBtn);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await setupExportButtons();
                
                // Load initial data
                document.getElementById('loading').textContent = '正在載入教師和班別數據...';
                
                // Simulate data loading (replace with actual API calls)
                setTimeout(() => {
                    const teacherDropdown = document.getElementById('teacherDropdown');
                    const classDropdown = document.getElementById('classDropdown');
                    
                    // Add sample teachers
                    ['張老師', '李老師', '王老師', '陳老師'].forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher;
                        option.textContent = teacher;
                        teacherDropdown.appendChild(option);
                    });
                    
                    // Add sample classes
                    ['1A', '1B', '2A', '2B', '3A', '3B'].forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        classDropdown.appendChild(option);
                    });
                    
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('result').textContent = '請選擇教師或班別以查看時間表';
                }, 1000);
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loading').textContent = '載入數據時發生錯誤';
            }
        });
    </script>

    <script nonce="r4nd0m123">
        // Load timetable.js with versioning
        (function loadTimetable() {
            const ASSET_VERSION = '1.1.0';
            const s = document.createElement('script');
            s.src = 'timetable.js?v=' + encodeURIComponent(ASSET_VERSION);
            s.defer = true;
            s.onerror = () => {
                document.getElementById('loading').textContent = '無法載入時間表模組';
            };
            document.head.appendChild(s);
        })();
    </script>
</body>
</html>
