<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSP 與 nonce -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'nonce-r4nd0m123' https://accounts.google.com https://cdnjs.cloudflare.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data:;
      frame-src 'self';
      connect-src 'self';
      frame-ancestors 'self';
      base-uri 'self';
      form-action 'self';
      object-src 'none';
      upgrade-insecure-requests
    ">

    <title>時間表查詢系統 - 佛教何南金中學</title>
    <style>
        html, body {
            height: 100%;
            margin: 0; padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        body {
            display: flex; flex-direction: column;
            max-width: 95%; margin: 0 auto; padding: 10px; box-sizing: border-box;
        }
        h2 {
            color: #2c3e50; text-align: center; margin: 0 0 20px 0; font-size: 1.0em;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        #todayDate { font-size: 12px; margin-left: auto; }
        #app-content { display: flex; flex-direction: column; flex: 1; overflow: hidden; height: 100%; }
        .tab-container { display: flex; flex-direction: column; flex: 1; gap: 0; overflow: hidden; }
        .tab-header { display: flex; border-bottom: 1px solid #ddd; justify-content: space-between; align-items: center; }
        .tab-buttons { display: flex; }
        .tab-button {
            padding: 5px 7px; background-color: #f1f1f1; border: none; cursor: pointer; font-size: 12px;
            transition: 0.3s; border-radius: 5px 5px 0 0; margin-right: 5px;
        }
        .tab-button:hover { background-color: #ddd; }
        .tab-button.active { background-color: #3498db; color: white; }
        #logout-button {
            padding: 10px 15px; background-color: #e74c3c; color: white; border: none; border-radius: 5px;
            cursor: pointer; font-size: 14px; transition: 0.3s; margin-left: 10px;
        }
        #logout-button:hover { background-color: #c0392b; }
        .tab-content {
            display: none; flex: 1; padding: 0; background: white; border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden;
        }
        .tab-content.active { display: flex; flex-direction: column; }
        iframe { flex: 1; width: 100%; border: none; border-radius: 0 0 5px 5px; }
        .loading { text-align: center; padding: 20px; font-style: italic; color: #666; }
        .footer { text-align: center; margin-top: 2px; padding-top: 2px; border-top: 1px solid #ddd; color: #666; font-size: 10px; flex-shrink: 0; }
        #inactivity-warning {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1000; text-align: center; width: min(90vw, 360px);
        }
        #inactivity-warning button {
            margin-top: 15px; padding: 8px 15px; background-color: #3498db; color: #fff; border: none; border-radius: 3px; cursor: pointer;
        }
        @media (prefers-color-scheme: dark) {
            html, body { background-color: #111; color: #eee; }
            .tab-content { background: #1c1c1c; box-shadow: none; }
            .tab-button { background-color: #2a2a2a; color: #ddd; }
            .tab-button.active { background-color: #1e6da3; color: #fff; }
        }
        @media (prefers-reduced-motion: reduce) {
            * { transition: none !important; animation: none !important; }
        }
    </style>
</head>
<body>
    <h2>
        <span>佛教何南金中學 - 時間表查詢系統</span>
        <span id="todayDate" aria-live="polite"></span>
    </h2>

    <div id="app-content">
        <div class="tab-container">
            <div class="tab-header">
                <div class="tab-buttons" role="tablist" aria-label="功能選單">
                    <button class="tab-button active" role="tab" id="tab-teacherTimetable" aria-controls="panel-teacherTimetable" aria-selected="true" tabindex="0" onclick="openTab(event, 'teacherTimetable')">教師/班別時間表</button>
                    <button class="tab-button" role="tab" id="tab-rooms" aria-controls="panel-rooms" aria-selected="false" tabindex="-1" onclick="openTab(event, 'rooms')">房間時間表</button>
                    <button class="tab-button" role="tab" id="tab-freePeriods" aria-controls="panel-freePeriods" aria-selected="false" tabindex="-1" onclick="openTab(event, 'freePeriods')">教師空堂查詢</button>
                    <button class="tab-button" role="tab" id="tab-commonFreePeriods" aria-controls="panel-commonFreePeriods" aria-selected="false" tabindex="-1" onclick="openTab(event, 'commonFreePeriods')">共同空堂搜尋</button>
                </div>
                <button id="logout-button" onclick="logout()">登出系統</button>
            </div>
            
            <div id="teacherTimetable" class="tab-content active" role="tabpanel" aria-labelledby="tab-teacherTimetable" id="panel-teacherTimetable">
                <div class="loading" role="status" aria-live="polite">載入教師/班別時間表查詢功能...</div>
                <iframe id="ttFrame" title="教師/班別時間表" loading="lazy" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer" onload="hideLoading('teacherTimetable')"></iframe>
            </div>
            
            <div id="rooms" class="tab-content" role="tabpanel" aria-labelledby="tab-rooms" id="panel-rooms">
                <div class="loading" role="status" aria-live="polite">載入房間時間表查詢功能...</div>
                <iframe id="roomFrame" title="房間時間表" loading="lazy" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer" onload="hideLoading('rooms')"></iframe>
            </div>

            <div id="freePeriods" class="tab-content" role="tabpanel" aria-labelledby="tab-freePeriods" id="panel-freePeriods">
                <div class="loading" role="status" aria-live="polite">載入教師空堂查詢功能...</div>
                <iframe id="freeFrame" title="教師空堂查詢" loading="lazy" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer" onload="hideLoading('freePeriods')"></iframe>
            </div>
            
            <div id="commonFreePeriods" class="tab-content" role="tabpanel" aria-labelledby="tab-commonFreePeriods" id="panel-commonFreePeriods">
                <div class="loading" role="status" aria-live="polite">載入共同空堂搜尋功能...</div>
                <iframe id="meetingFrame" title="共同空堂搜尋" loading="lazy" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer" onload="hideLoading('commonFreePeriods')"></iframe>
            </div>
        </div>
        
        <div class="footer">
            <p>© <span id="spanYear"></span> 佛教何南金中學 - 時間表查詢系統 | 版本 1.1</p>
        </div>
    </div>
    
    <!-- Inactivity warning modal -->
    <div id="inactivity-warning" role="dialog" aria-modal="true" aria-labelledby="idleTitle" aria-describedby="idleDesc">
        <h3 id="idleTitle">閒置警告</h3>
        <p id="idleDesc">由於長時間無活動，系統將在 <span id="countdown">60</span> 秒後自動登出。</p>
        <p>請點擊下方按鈕繼續使用系統。</p>
        <button id="idleContinueBtn" onclick="resetInactivityTimer(true)">繼續使用</button>
    </div>

    <script nonce="r4nd0m123">
        // 參數設定
        const CLIENT_ID = "920942611875-eikfedkn3rno9am41fi08sbqniml566c.apps.googleusercontent.com";
        const SCHOOL_DOMAIN = "bhnkc.edu.hk";
        const STUDENT_ACCOUNT_REGEX = /^s[a-zA-Z0-9]{7}@bhnkc\.edu\.hk$/i;
        const TOKEN_SKEW_MS = 60 * 1000;
        const ENABLE_DEVTOOLS_BLOCK = false;

        // Idle 控制
        let inactivityTimer;      // 前景用（非關鍵）
        let warningTimer;         // 前景用（非關鍵）
        let countdownInterval;
        const WARNING_TIME = 60;         // 秒
        const LOGOUT_TIME = 30 * 60 * 1000; // 30分鐘
        const NEAR_EXP_THRESHOLD_MS = 2 * 60 * 1000; // Token 近過期提示門檻（可視需求使用）

        // 可選：封鎖右鍵與開發者工具（預設關閉）
        if (ENABLE_DEVTOOLS_BLOCK) {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('keydown', e => {
                if (e.key === 'F12' ||
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
                    (e.ctrlKey && e.key.toLowerCase() === 'u')) {
                    e.preventDefault();
                }
            });
        }

        // 日期顯示
        (function showToday() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById("todayDate").textContent = today.toLocaleDateString('zh-TW', options);
        })();

        // Token 驗證
        function decodeJwtResponse(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                return JSON.parse(jsonPayload);
            } catch { return null; }
        }
        function isTokenValid(token) {
            const p = decodeJwtResponse(token);
            if (!p) return false;
            const issOk = p.iss === "https://accounts.google.com" || p.iss === "accounts.google.com";
            const audOk = p.aud === CLIENT_ID;
            const hdOk = p.hd === SCHOOL_DOMAIN;
            const notStudent = !STUDENT_ACCOUNT_REGEX.test(p.email || "");
            const notExpired = p.exp && Date.now() < (p.exp * 1000 - TOKEN_SKEW_MS);
            return issOk && audOk && hdOk && notStudent && notExpired;
        }

        // 登出與跨分頁同步
        function broadcastLogout() {
            try { localStorage.setItem('app:logout', String(Date.now())); } catch {}
        }
        function logout() {
            clearTimeout(inactivityTimer);
            clearTimeout(warningTimer);
            clearInterval(countdownInterval);
            sessionStorage.removeItem('google_id_token');
            sessionStorage.removeItem('inactivity.logoutAt');
            sessionStorage.removeItem('inactivity.warningAt');
            sessionStorage.removeItem('inactivity.lastActiveAt');
            if (window.google?.accounts?.id) google.accounts.id.disableAutoSelect();
            broadcastLogout();
            window.location.href = "index.html";
        }
        window.addEventListener('storage', (e) => {
            if (e.key === 'app:logout') logout();
        });

        // 閒置控制（絕對門檻）
        function resetInactivityTimer(closeWarning = false) {
            const now = Date.now();
            const logoutAt = now + LOGOUT_TIME;
            const warningAt = logoutAt - (WARNING_TIME * 1000);
            sessionStorage.setItem('inactivity.lastActiveAt', String(now));
            sessionStorage.setItem('inactivity.logoutAt', String(logoutAt));
            sessionStorage.setItem('inactivity.warningAt', String(warningAt));
            clearTimeout(inactivityTimer);
            clearTimeout(warningTimer);
            clearInterval(countdownInterval);
            if (closeWarning) document.getElementById('inactivity-warning').style.display = 'none';
            inactivityTimer = setTimeout(showInactivityWarning, LOGOUT_TIME - (WARNING_TIME * 1000));
            warningTimer = setTimeout(logoutDueToInactivity, LOGOUT_TIME);
        }
        function showInactivityWarning() {
            const logoutAt = parseInt(sessionStorage.getItem('inactivity.logoutAt') || '0', 10);
            const now = Date.now();
            let remainingMs = Math.max(0, logoutAt - now);
            let seconds = Math.ceil(remainingMs / 1000);
            document.getElementById('inactivity-warning').style.display = 'block';
            document.getElementById('idleContinueBtn').focus();
            document.getElementById('countdown').textContent = seconds;
            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const remain = Math.max(0, parseInt(sessionStorage.getItem('inactivity.logoutAt') || '0', 10) - Date.now());
                const s = Math.ceil(remain / 1000);
                document.getElementById('countdown').textContent = s;
                if (remain <= 0) clearInterval(countdownInterval);
            }, 1000);
        }
        function logoutDueToInactivity() {
            alert("由於30分鐘無活動，系統已自動登出以確保安全。");
            logout();
        }
        function checkResumeState() {
            const idToken = sessionStorage.getItem('google_id_token');
            if (!idToken || !isTokenValid(idToken)) {
                logout(); return;
            }
            const logoutAt = parseInt(sessionStorage.getItem('inactivity.logoutAt') || '0', 10);
            const warningAt = parseInt(sessionStorage.getItem('inactivity.warningAt') || '0', 10);
            const now = Date.now();
            if (logoutAt && now >= logoutAt) { logoutDueToInactivity(); return; }
            if (warningAt && now >= warningAt) { showInactivityWarning(); }
        }

        // Iframe 載入（lazy）
        const routes = {
            teacherTimetable: "tt.html",
            rooms: "room.html",
            freePeriods: "free.html",
            commonFreePeriods: "bysub.html"
        };
        function loadIframesInitial() {
            // 只先載入第一個頁籤
            const tt = document.getElementById('ttFrame');
            if (!tt.src) tt.src = routes.teacherTimetable;
        }

        // A11y Tabs 操作
        function setActiveTab(tabName) {
            const ids = ['teacherTimetable','rooms','freePeriods','commonFreePeriods'];
            ids.forEach(id => {
                const btn = document.getElementById('tab-' + id);
                const panel = document.getElementById(id);
                const active = (id === tabName);
                btn.classList.toggle('active', active);
                btn.setAttribute('aria-selected', String(active));
                btn.tabIndex = active ? 0 : -1;
                panel.classList.toggle('active', active);
            });
        }
        function ensureIframe(tabName) {
            const map = {
                teacherTimetable: 'ttFrame',
                rooms: 'roomFrame',
                freePeriods: 'freeFrame',
                commonFreePeriods: 'meetingFrame'
            };
            const frameId = map[tabName];
            const iframe = document.getElementById(frameId);
            if (iframe && !iframe.src) iframe.src = routes[tabName];
        }
        function openTab(evt, tabName) {
            setActiveTab(tabName);
            ensureIframe(tabName);
            document.getElementById('tab-' + tabName).focus();
        }
        // 鍵盤操作（左右鍵、Home/End）
        document.querySelector('.tab-buttons').addEventListener('keydown', (e) => {
            const order = ['teacherTimetable','rooms','freePeriods','commonFreePeriods'];
            const current = order.findIndex(id => document.getElementById('tab-' + id).getAttribute('aria-selected') === 'true');
            if (e.key === 'ArrowRight') {
                const next = (current + 1) % order.length;
                openTab(null, order[next]); e.preventDefault();
            } else if (e.key === 'ArrowLeft') {
                const prev = (current - 1 + order.length) % order.length;
                openTab(null, order[prev]); e.preventDefault();
            } else if (e.key === 'Home') {
                openTab(null, order[0]); e.preventDefault();
            } else if (e.key === 'End') {
                openTab(null, order[order.length - 1]); e.preventDefault();
            }
        });

        // 載入時初始化
        window.addEventListener('load', () => {
            // Token 驗證
            const idToken = sessionStorage.getItem('google_id_token');
            if (!idToken || !isTokenValid(idToken)) {
                sessionStorage.removeItem('google_id_token');
                window.location.href = "index.html"; return;
            }
            // 年份
            document.getElementById('spanYear').textContent = new Date().getFullYear();
            // 初始化 iframe 與活動追蹤
            loadIframesInitial();
            setupActivityTracking();
        });

        // 從背景回來時檢查
        window.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') checkResumeState();
        });
        window.addEventListener('focus', checkResumeState);

        // 隱藏載入訊息
        function hideLoading(tabId) {
            const tab = document.getElementById(tabId);
            const loading = tab?.querySelector('.loading');
            if (loading) loading.style.display = 'none';
        }

        // 追蹤互動（包含 iframe）
        function setupActivityTracking() {
            const activity = () => resetInactivityTimer();
            window.addEventListener('mousemove', activity);
            window.addEventListener('keypress', activity);
            window.addEventListener('click', activity);
            window.addEventListener('scroll', activity, { passive: true });
            const addIframeActivity = (frame) => {
                try {
                    const w = frame.contentWindow;
                    w.addEventListener('mousemove', activity);
                    w.addEventListener('click', activity);
                    w.addEventListener('keypress', activity);
                    w.addEventListener('scroll', activity, { passive: true });
                } catch (e) { console.warn('無法為 iframe 綁定活動監聽：', e); }
            };
            document.getElementById('ttFrame').addEventListener('load', function(){ addIframeActivity(this); });
            document.getElementById('roomFrame').addEventListener('load', function(){ addIframeActivity(this); });
            document.getElementById('freeFrame').addEventListener('load', function(){ addIframeActivity(this); });
            document.getElementById('meetingFrame').addEventListener('load', function(){ addIframeActivity(this); });
            resetInactivityTimer();
        }
    </script>
</body>
</html>
