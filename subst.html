<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師代課系統</title>
    <style>
        /* 保持原有樣式不變 */
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        /* 其他樣式... */
    </style>
</head>
<body>
    <!-- 保持原有HTML結構 -->
    <script>
        // 全局變量
        let timetableData = [];
        let substData = {};
        let allTeachers = [];

        // 主初始化函數
        async function initApp() {
            try {
                showLoading("正在初始化系統...");
                
                // 先載入靜態界面
                initStaticUI();
                
                // 並行載入兩個CSV文件
                const [ttCSV, substCSV] = await Promise.all([
                    loadCSVFile('tt.csv'),
                    loadCSVFile('subst.csv')
                ]);
                
                // 解析數據
                timetableData = parseTimetableData(ttCSV);
                substData = parseSubstitutionData(substCSV);
                
                // 初始化教師相關UI
                initTeacherUI();
                
                showReady();
            } catch (error) {
                showError("初始化失敗: " + error.message);
                console.error("初始化錯誤:", error);
            }
        }

        // 載入CSV文件
        async function loadCSVFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                let text = await response.text();
                return text.replace(/^\uFEFF/, ''); // 移除BOM
            } catch (error) {
                console.error(`載入 ${filename} 失敗:`, error);
                throw new Error(`無法載入 ${filename}`);
            }
        }

        // 解析課程表數據
        function parseTimetableData(csv) {
            const result = [];
            const lines = csv.split(/\r?\n/).filter(line => line.trim());
            
            // 跳過標題行（如果存在）
            const startLine = lines[0].match(/^[^0-9]/) ? 1 : 0;
            
            for (let i = startLine; i < lines.length; i++) {
                const line = lines[i];
                const parts = line.split(',').map(part => part.trim());
                
                if (parts.length >= 7) {
                    result.push({
                        year: parts[0],
                        day: parseInt(parts[1]) || 0,
                        period: parseInt(parts[2]) || 0,
                        teacher: parts[3],
                        class: parts[4],
                        subject: parts[5],
                        room: parts[6]
                    });
                }
            }
            return result;
        }

        // 解析代課數據（新增的函數）
        function parseSubstitutionData(csv) {
            const result = {};
            const lines = csv.split(/\r?\n/).filter(line => line.trim());
            
            for (const line of lines) {
                const [teacher, value] = line.split(',').map(item => item.trim());
                if (teacher && !isNaN(value)) {
                    result[teacher] = parseInt(value);
                }
            }
            return result;
        }

        // 初始化靜態UI
        function initStaticUI() {
            // 初始化星期選擇下拉框
            const daySelect = document.getElementById('daySelect');
            daySelect.innerHTML = '';
            ['星期一', '星期二', '星期三', '星期四', '星期五'].forEach((day, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = day;
                daySelect.appendChild(option);
            });
        }

        // 初始化教師相關UI
        function initTeacherUI() {
            // 獲取所有教師並排序
            allTeachers = [...new Set(timetableData.map(item => item.teacher))].sort();
            
            // 初始化教師下拉框
            const teacherSelect = document.getElementById('teacherSelect');
            teacherSelect.innerHTML = '<option value="">-- 選擇教師 --</option>';
            
            allTeachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                teacherSelect.appendChild(option);
            });
            
            // 設置輸入框聯動
            document.getElementById('teacherInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const options = teacherSelect.options;
                
                for (let i = 0; i < options.length; i++) {
                    if (options[i].text.toLowerCase().includes(searchTerm)) {
                        teacherSelect.selectedIndex = i;
                        break;
                    }
                }
            });
        }

        // 顯示狀態函數
        function showLoading(message) {
            document.getElementById('result').innerHTML = `<div class="loading">${message}</div>`;
        }
        
        function showReady() {
            document.getElementById('result').innerHTML = '<div class="loading">系統準備就緒，請輸入查詢條件</div>';
        }
        
        function showError(message) {
            document.getElementById('result').innerHTML = `<div class="error">${message}</div>`;
        }

        // 啟動應用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
